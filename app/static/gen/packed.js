window.App={Models:{},Collections:{},Views:{},Router:{}};App.Router.MainRouter=Backbone.Router.extend({routes:{'':'start','create':'create','edit/:id':'edit'},start:function(){console.log('now in view'+Backbone.history.location.href);var page_mark=Backbone.history.location.pathname.split("/")[2];if(page_mark=="home"||page_mark=="gallery"){var photolist=new App.Collections.PhotoList(initialdata);new App.Views.MainView({el:"#photoapp",collection:photolist,page_mark:page_mark});}
},edit:function(id){console.log('edit route with id: '+id);},create:function(){console.log('View for creating photos rendered');}});App.Models.Photo=Backbone.Model.extend({defaults:{author:'',header:'',body:'',photo:'',subject:'',read:false,star:false,selected:false,archived:false,label:'',static_url:'https://s3.amazonaws.com/aperturus/'},validate:function(attrs){if(!attrs.header){alert('Your post must have a title!');}
if(!attrs.body){alert('Your post must have a story');}},markRead:function(){this.save({read:true});},starMail:function(){this.save({star:!this.get("star")});},archive:function(){this.save({archived:true,selected:false});},selectMail:function(){this.save({selected:!this.get("selected")});},setLabel:function(label){this.save({label:label});}});App.Views.PhotoMainView=Backbone.View.extend({initialize:function(){this.model.bind('change',this.render,this);},render:function(){this.$el.html(nunjucks.render("main_entry.html",this.model.toJSON()));return this;},unrender:function(){$(this.el).remove();}});App.Views.PhotoListView=Backbone.View.extend({tagName:"li",initialize:function(){this.model.bind('change',this.render,this);},render:function(){this.$el.html(nunjucks.render("archive_entry.html",this.model.toJSON()));return this;},unrender:function(){$(this.el).remove();}});App.Views.MainView=Backbone.View.extend({initialize:function(options){_.extend(this,_.pick(options,"page_mark"));this.renderMainPhoto(this.collection.models[0]);this.renderPhotoList(this.collection);this.renderTitle();},events:{"change #labeler":"applyLabel","click #markallread":"markallread","click #archive":"archive","click #allmail":"allmail","click #inbox":"inbox","click #starred":"starred","keyup #search":"search"},search:function(){this.render(this.collection.search($("#search").val()));},starred:function(){this.render(this.collection.starred());},inbox:function(){this.render(this.collection.inbox());},allmail:function(){this.render(this.collection);},markallread:function(){this.collection.each(function(item){item.markRead();},this);},applyLabel:function(){var label=$("#labeler").val();this.collection.each(function(item){if(item.get('selected')==true){item.setLabel(label);}},this);},archive:function(){this.collection.each(function(item){if(item.get('selected')==true){item.archive();}},this);this.render(this.collection.inbox());},renderTitle:function(){$("#headline").html(nunjucks.render('title.html',{'page_mark':this.page_mark}));},renderMainPhoto:function(latestrecord){$('div#photo-main',this.el).html('');var photoMainView=new App.Views.PhotoMainView({el:"#photo-main",model:latestrecord});$('div#photo-main',this.el).append(photoMainView.render().el);},renderPhotoList:function(collection){var target=$('ul#img-list',this.el);target.html('');var self=this;_.each(collection.models.slice(1,7),function(model){console.log(model.get("id"));self.addOneToList(model);},this);},addOneToList:function(photo){var photoView=new App.Views.PhotoListView({model:photo});$('ul#img-list',this.el).append(photoView.render().el);}
});App.Collections.PhotoList=Backbone.Collection.extend({model:App.Models.Photo,localStorage:new Backbone.LocalStorage("photos"),unread:function(){return _(this.filter(function(photo){return!photo.get('read');}));},inbox:function(){return _(this.filter(function(photo){return!photo.get('archived');}));},starred:function(){return _(this.filter(function(photo){return photo.get('star');}));},unread_count:function(){return(this.filter(function(photo){return!photo.get('read');})).length;},labelled:function(label){return _(this.filter(function(photo){return label in photo.get('label')}));},starcount:function(){return(this.filter(function(photo){return photo.get('star')})).length;},search:function(word){if(word=="")return this;var pat=new RegExp(word,'gi');return _(this.filter(function(photo){return pat.test(photo.get('subject'))||pat.test(photo.get('sender'));}));},byauthor:function(author_id){var filtered=this.filter(function(post){return photo.get("author")===author_id;});return new App.Collections.PhotoList(filtered);},comparator:function(photo){return-photo.get('timestamp');}});$(document).ready(function(){scrollinit();var env=nunjucks.configure('/static/templates');env.addGlobal("static_url",'https://s3.amazonaws.com/aperturus/')
new App.Router.MainRouter();Backbone.history.start();var csrftoken=$('meta[name=csrf-token]').attr('content');$(function(){$.ajaxSetup({beforeSend:function(xhr,settings){if(!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type)&&!this.crossDomain){xhr.setRequestHeader("X-CSRFToken",csrftoken)}}})});});var $nav=$('.navbar'),$body=$('body'),$window=$(window),$popoverLink=$('[data-popover]'),navOffsetTop=$nav.offset().top,$document=$(document);function scrollinit(){$window.on('scroll',onScroll);$window.on('resize',resize);$popoverLink.on('click',openPopover);$document.on('click',closePopover);$('a[href^="#"]').on('click',smoothScroll)}
function smoothScroll(e){e.preventDefault();$(document).off("scroll");var target=this.hash,menu=target;$target=$(target);$('html, body').stop().animate({'scrollTop':$target.offset().top-40},0,'swing',function(){window.location.hash=target;$(document).on("scroll",onScroll);});}
function openPopover(e){e.preventDefault();closePopover();var popover=$($(this).data('popover'));popover.toggleClass('open');e.stopImmediatePropagation();}
function closePopover(e){if($('.popover.open').length>0){$('.popover').removeClass('open')}}
$("#button").click(function(){$('html, body').animate({scrollTop:$("#elementtoScrollToID").offset().top},2000);});function resize(){$body.removeClass('has-docked-nav');navOffsetTop=$nav.offset().top;onScroll()}
function onScroll(){if(navOffsetTop<$window.scrollTop()&&!$body.hasClass('has-docked-nav')){$body.addClass('has-docked-nav')}
if(navOffsetTop>$window.scrollTop()&&$body.hasClass('has-docked-nav')){$body.removeClass('has-docked-nav')}}